<!doctype html>
<html lang="en">
<head>
    <title>CateringService</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1 user-scalable=0"/>    
    <script src="../lib/jquery.js"></script>
    <script src="../lib/jqmobile/jquery.mobile.custom.js"></script>    
    <link rel="stylesheet" href="../lib/jqmobile/jquery.mobile.custom.structure.css"/>
    <link rel="stylesheet" href="../lib/jqmobile/jquery.mobile.custom.theme.css" />    
    <link rel="stylesheet" href="../style/index.css"/>
    <link rel="stylesheet" href="../style/myTran.css"/>
    <script src="../lib/swipe.js"></script>
    <script src="../lib/myTran.js"></script>
    <style>   
        *{ margin:0; padding: 0;}
        li{ list-style-type: none;}
        img{ max-width: 100%; display: block; margin: 0 auto 1px auto;}
        html,body{ width: 100%; height: 100%; background: #fff; 
            -webkit-tap-highlight-color: rgba(88,44,22,0.9);
            -webkit-touch-callout: none; 
            -webkit-user-select: none;             
        }    
        div.hide{display:none}
        .po_relative{position:relative}
        .po_absolute{position:absolute;top:0;left:0;z-index:-1;}
        .main{ width: 100%; height: auto;}
        .main section{ width: 100%; height: auto;left: 0; top:0; }
        .main section div{ width: 100%;left: 0; top:0; }
        .main section.hide{ display: none;}
        .main section.curr{ display: block;} 
        .clearfix:after {clear: both;content: "";display: block;visibility: hidden;}
        .menu{ width: 100%; position: fixed; bottom:0;left:0;z-index:30;background:#fff }
        .menu.menucurr{ background: #fff;}
        .menu ul{width: 100%; height: 100%; }
        .menu li{ width: 16.66%; float: left;text-align: center; background: #fff; font-size:8rem;color:#999;}
        .menu li.curr{color:#000}   
        .menu ul i{line-height:2rem;font-size:8rem;}
        .menu li p{line-height:2rem;font-size:2rem;text-align:center;margin:0 0 2px 0}        
        
        .detail{width: 100%; height: 100%; position:relative;top:0;left:0;z-index:20;background-color:#fff}
        .detail div{background-color:#fff}
        .detail hr{width:100%;color:#ccc;size:1;}       
        .filter{filter:alpha(opacity=50);-moz-opacity:0.5;-khtml-opacity: 0.5;opacity: 0.5;}
        .bottom{width:100%;height: 5rem;}
        .loading{color:#000;position:absolute;width:100%;top:0;bottom:0;text-align:center;background-image:url('../res/ajax-loader.gif');background-color:rgba(0,0,0,0.8);background-position:center;background-repeat:no-repeat}
        .loading img{width:2.7rem;height:2.7rem;position:absolute;top:0;left:0;right:0;bottom:0}
        .main_mask{position:absolute;top:0;left:0; width:100%;height:100%;filter:alpha(opacity=30);-moz-opacity:0.3;-khtml-opacity: 0.3;opacity: 0.3;background-color:#000;z-index:10;}
        .muti_img{position:relative;}       
         
        #position{text-align: center;font-size: 10rem;line-height: 2rem;color: #fff;display: block;position: absolute;bottom: 2rem;left: 50%;margin-left: -50%;width: 100%;}
        #position em.on{color:#FBFA4F}   
        
        .ui-overlay-a, .ui-page-theme-a, .ui-page-theme-a .ui-panel-wrapper
        {
            background-color:transparent
        }    
        .ui-mobile .ui-page {min-height: 100%;}
        
        /* Swipe 2 required styles */

        .swipe {
          overflow:hidden;
          visibility: hidden;
          position: relative;
        }
        .swipe-wrap {
          overflow:hidden;
          position: relative;
        }
        .swipe-wrap > div {
          float:left;
          width:100%;
          position: relative;
        }        
       /* END required styles */
    </style>

    <script>
        (function () {
            var adjust = function () {
                var width, dom = document.getElementsByTagName("html")[0];
                return function () {
                    var w = Math.min(dom.offsetWidth, 480);
                    if (width != w) {
                        width = w;
                        dom.style.fontSize = (10 / 720 * width) + "px";
                    }
                };
            } ();
            adjust();
            window.addEventListener("resize", function () { setTimeout(adjust, 200); }, false);
        } ());
    </script>
</head>
<body>    
    <div id="page1">
        <div class="main po_relative" id="main">                
            <section class="curr" id="sec-menu-all">          
            </section>
            <section  class="hide" id="sec-menu-1">           
            </section>
            <section class="hide" id="sec-menu-2">            
            </section>
            <section class="hide" id="sec-menu-3">            
            </section>
            <section class="hide" id="sec-menu-4">            
            </section>
            <section class="hide" id="sec-menu-5">
            </section>
            <div class="main_mask hide"></div>            
        </div>
        <div class="menu">
            <ul class="clearfix">
                <li index='0' class="curr">
                    <i class="icon icon_menuNear"></i>
                    <p>附近</p>
                </li>
                <li index='1'>
                    <i class="icon icon_dutyFree"></i>
                    <p>免税店</p>
                </li>
                <li index='2'>
                    <i class="icon icon_menuFood"></i>
                    <p>快餐</p>
                </li>
                <li index='3'>
                    <i class="icon icon_menuCoffee"></i>
                    <p>咖啡</p>
                </li>
                <li index='4'>
                    <i class="icon icon_menuRestaurant"></i>
                    <p>正餐</p>
                </li>
                <li index='5'>
                    <i class="icon icon_menuShop"></i>
                    <p>购物</p>
                </li>
            </ul>
        </div>    
    </div>

    <div id="page2">
        <div class="detail hide" id="detail">        
            <div id='mySwipe' style='max-width:100%;' class='swipe'>
                <div class='swipe-wrap'>
                <div><img src="../res/menu-1/shop-1/picture-1.jpg" alt=""/></div>
                <div><img src="../res/menu-1/shop-1/picture-2.jpg" alt=""/></div>
                <div><img src="../res/menu-1/shop-1/picture-3.jpg" alt=""/></div>
                <div><img src="../res/menu-1/shop-1/picture-4.jpg" alt=""/></div>            
                </div>
                <span id="position">
                <em class="on">•</em>
                <em>•</em>
                <em>•</em>
                <em>•</em>
                </span>
            </div>        
            <div style="vertical-align:middle;line-height:7rem;">
                <div style="margin: 2rem 0 0 4rem;">
                <span id="detail_name" style="font-size:6rem;font-family:@黑体;font-weight:bold;">太平洋咖啡</span>
                </div>          
                <img style="width:15rem;height:2.5rem;margin: 0 0 5rem 4rem" src="../res/score.png" alt=""/>          
            </div>
            <hr />
            <div style="vertical-align:middle;line-height:12rem">
                <span style="font-size:3.6rem;font-family:@黑体;margin-left:4rem">距离50米 人均￥40  时间 5:00-23:00</span>
            </div>
            <hr />
            <div>
                <div style="text-align:left;vertical-align:middle;line-height:12rem;margin-left:4rem">              
                    <i class="icon icon_telephone" style="color:#fff;font-size:5rem;color:#999;"></i>
                    <a href="tel:010-68789876" style="font-size:5rem;font-family:Arial;color:#999;text-decoration:none;">&nbsp;&nbsp;010 - 68789876&nbsp;&nbsp;</a>                                            
                    <i class="icon icon_telephone" style="font-size:5rem;color:#999;margin-right:2rem"></i>
                </div>          
            </div>
            <hr />
            <img src="../res/map-1.jpg" alt="" style="max-width: 100%; display: block;"/>        
        </div>
    </div>
</body>
<script>
    //阻止横屏
    $(window).on('orientationchange', function (e) {
        e.preventDefault();
    });
    $(document).ready(function () {
        var isLoading = false;
        var imgMap = {};
        var menuIndex = 0;
        var menuLength = 5;
        var bullets = document.getElementById('position').getElementsByTagName('em');
        var mainScrollTop = 0;
        var imgData = [{
            class: 'sec-menu-1',
            path: '../res/menu-1/',
            sub: 'shop-',
            pic_pre: 'picture-',
            len: 12,
            names: ['太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '千岛咖啡', '真功夫']
        }, {
            class: 'sec-menu-2',
            path: '../res/menu-2/',
            sub: 'shop-',
            pic_pre: 'picture-',
            len: 12,
            names: ['太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '千岛咖啡', '真功夫']
        }, {
            class: 'sec-menu-3',
            path: '../res/menu-3/',
            sub: 'shop-',
            pic_pre: 'picture-',
            len: 12,
            names: ['太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '千岛咖啡', '真功夫']
        }, {
            class: 'sec-menu-4',
            path: '../res/menu-4/',
            sub: 'shop-',
            pic_pre: 'picture-',
            len: 12,
            names: ['太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '千岛咖啡', '真功夫']
        }, {
            class: 'sec-menu-5',
            path: '../res/menu-5/',
            sub: 'shop-',
            pic_pre: 'picture-',
            len: 12,
            names: ['太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '千岛咖啡', '真功夫']
        }, {
            class: 'sec-menu-6',
            path: '../res/menu-6/',
            sub: 'shop-',
            pic_pre: 'picture-',
            len: 12,
            names: ['太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '太平洋咖啡', 'KFC', '麦当劳', '千岛咖啡', '真功夫', '千岛咖啡', '真功夫']
        }]

        $.each(imgData, function (index, item) {
            imgMap[item.class] = item;
        })

        function swipeMenu(isRight) {
            menuIndex = isRight ? menuIndex + 1 : menuIndex - 1;
            if (menuIndex > menuLength) menuIndex = 0;
            if (menuIndex < 0) menuIndex = menuLength;
            var lis = $('.menu li');
            if (lis) {
                lis.removeClass("curr");
                $(lis[menuIndex]).addClass("curr");
                $(".main section").siblings().hide().eq(menuIndex).show();
            }
        }

        function loadTarget(id) {
            isLoading = true;
            var img = $('#' + id);
            var parentDIv = img.parent('div')
            if (parentDIv) {
                var loading = '<div class="loading"></div>';
                parentDIv.append(loading);
            }
            loadDetail(id);
            setTimeout(function () {
                isLoading = false;
                parentDIv.children('.loading').remove();
                showDetail(id);
            }, 1000)
        }

        function pullup() { //上滑动作                      
            $('.main').addClass('po_absolute');
            $('.main').removeClass('hide');
            $('.main_mask').removeClass('hide');
            myTran.goTo('myslide', '', '#page1', '#page2');
            setTimeout(function () {
                showMain();
            }, 400)
        }

        function showMain() {
            myTran.restore('myslide', '#page2');
            $('.main').removeClass('hide');
            $('.main').removeClass('po_absolute');
            $('.main').addClass('po_relative');
            $('.menu').removeClass('hide');
            $('.main_mask').addClass('hide');
            //window.scrollTo(0, mainScrollTop);
            $('.detail').addClass('hide');
        }

        function showDetail() {
            $('.main').addClass('hide');
            $('.menu').addClass('hide');
            window.scrollTo(0, 0);
            $('.detail').removeClass('hide');

            var elem = document.getElementById('mySwipe');
            window.mySwipe = Swipe(elem, {
                startSlide: 0,
                auto: 3000,
                continuous: true,
                disableScroll: true,
                stopPropagation: true,
                callback: function (e, pos) {
                    var index = e;
                    var i = bullets.length;
                    while (i--) {
                        $(bullets[i]).removeClass('on');
                    }
                    $(bullets[e]).addClass('on');
                }
            });
        }

        function loadDetail(id) {
            var args = id.split('_');
            var cls = args[1];
            var index = parseInt(args[2]);
            var imgObj = imgMap[cls];
            mainScrollTop = document.body.scrollTop;
            var name = imgObj.names[index];
            $('#detail_name').html(name);

            var swip = $('.swipe-wrap');
            swip.children('div').remove();
            for (var i = 0; i < 4; i++) {
                var imgSrc = imgObj.path + imgObj.sub + (index + 1) + '/picture-' + (i + 1) + '.jpg';
                var swipImg = '<div><img src="' + imgSrc + '" alt=""/></div>';
                swip.append(swipImg);
            }
        }

        function initDom() {
            var sectionAll = $('#sec-menu-all');
            $(imgData).each(function (index) {
                var item = imgData[index];
                var par = $('#' + item.class);
                if (par) {
                    for (var i = 0; i < item.len; i++) {
                        var imgPath = item.path + item.sub + (i + 1) + '/' + item.pic_pre + '0.jpg';
                        var imgId = 'img_' + item.class + '_' + i;
                        var img = '<div class="muti_img"><img src="' + imgPath + '" alt="" id="' + imgId + '"></div>';
                        if (sectionAll.children().length < 12) {
                            sectionAll.append(img);
                        }
                        par.append(img);
                    }
                }
            });
            $('#main').on('tap', 'img', function (e) {
                var targetId = this.id;
                if (targetId && !isLoading) {
                    loadTarget(targetId)
                }
            })
            $('#detail').on('touchstart', function (e) {
                startx = e.originalEvent.targetTouches[0].pageX;
                starty = e.originalEvent.targetTouches[0].pageY;
                startAtEnd = isPageEnd();
            })
            $('#detail').on('touchmove', function (e) {
                var cx = e.originalEvent.targetTouches[0].pageX;
                var cy = e.originalEvent.targetTouches[0].pageY;
                var direction = starty - cy > 0 ? 1 : 0;
                if (direction == 1 && startAtEnd) {
                    e.preventDefault();
                }
            })
            $('#detail').on('touchend', function (e) {
                endx = e.originalEvent.changedTouches[0].pageX;
                endy = e.originalEvent.changedTouches[0].pageY;
                var direction = starty - endy > 0 ? 1 : 0;
                var dy = Math.abs(starty - endy);
                if (direction == 1 && dy >= 50 && startAtEnd) {
                    e.preventDefault();
                    pullup();
                }
                else {
                    startAtEnd = false;
                }
            })
        }

        //判断屏幕是否在底部
        function isPageEnd() {
            var pageHeight = document.body.scrollHeight;
            var screenHeight = document.body.clientHeight;
            var scrollTop = document.body.scrollTop;
            if (Math.abs(pageHeight - scrollTop - screenHeight) <= 5) {
                return true;
            }
            return false
        }

        //返回角度
        function GetSlideAngle(dx, dy) {
            return Math.atan2(dy, dx) * 180 / Math.PI;
        }
        //根据起点和终点返回方向 1：向上，2：向下，3：向左，4：向右,0：未滑动
        function GetSlideDirection(startX, startY, endX, endY) {
            var dy = startY - endY;
            var dx = endX - startX;
            var result = 0;

            //如果滑动距离太短
            if (Math.abs(dx) < 2 && Math.abs(dy) < 2) {
                return result;
            }

            var angle = GetSlideAngle(dx, dy);
            if (angle >= -45 && angle < 45) {
                result = 4;
            } else if (angle >= 45 && angle < 135) {
                result = 1;
            } else if (angle >= -135 && angle < -45) {
                result = 2;
            }
            else if ((angle >= 135 && angle <= 180) || (angle >= -180 && angle < -135)) {
                result = 3;
            }

            return result;
        }

        var startx, starty, movex, movey, endx, endy, startAtEnd = false, mainStartx, mainStarty, mainEndx, mainEndy;
        function menuEvent() {
            $(".menu li").each(function (index) {
                $(this).on('tap', function (e) {
                    menuIndex = parseInt($(e.target).parent('li').attr('index'));
                    $(this).addClass("curr").siblings().removeClass("curr");
                    $(".main section").eq(index).show().siblings().hide();
                    window.scrollTo(0, 0);
                })
            })
        }

        initDom();
        menuEvent();
    });


    
</script>
</html>